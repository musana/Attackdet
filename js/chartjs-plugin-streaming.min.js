/*
 * @license
 * chartjs-plugin-streaming
 * http://github.com/nagix/chartjs-plugin-streaming/
 * Version: 1.2.0
 *
 * Copyright 2017 Akihiko Kusanagi
 * Released under the MIT license
 * https://github.com/nagix/chartjs-plugin-streaming/blob/master/LICENSE.md
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js"),require("moment")):"function"==typeof define&&define.amd?define(["chart.js","moment"],t):e["chartjs-plugin-streaming"]=t(e.Chart,e.moment)}(this,function(e,t){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;!function(e,t){function a(e){return null!==e&&"[object Object]"===Object.prototype.toString.call(e)}function r(e,t){return void 0===e?t:e}function i(e){if(f.isArray(e))return e.map(i);if(a(e)){for(var t={},r=Object.keys(e),n=r.length,o=0;o<n;++o)t[r[o]]=i(e[r[o]]);return t}return e}function n(e,t,r,n){var o=t[e],s=r[e];a(o)&&a(s)?f.merge(o,s,n):t[e]=i(s)}function o(e,a,r){var i=[];if(e.maxTicks){var n=e.stepSize,o=void 0!==e.min?e.min:r.min,s=e.majorUnit,l=(s?t(o).add(1,s).startOf(s):o).valueOf()-o,u=d[e.unit].size*n,c=l%u,p=o;c&&s&&!e.timeOpts.round&&!e.timeOpts.isoWeekday?(p+=c-u,i.push(p)):i.push(o);for(var f=t(p),m=e.max||r.max;f.add(n,e.unit).valueOf()<m;)i.push(f.valueOf());i.push(f.valueOf())}return i}function s(e,t,a,r){for(var i,n=Object.keys(d),o=n.length,s=n.indexOf(e);s<o;s++){i=n[s];var l=d[i],u=l.steps&&l.steps[l.steps.length-1]||l.maxStep;if(void 0===u||Math.ceil((a-t)/(u*l.size))<=r)break}return i}function l(e){for(var t=Object.keys(d),a=t.indexOf(e);a<t.length;){var r=t[++a];if("week"!==r&&"quarter"!==r)return r}return null}function u(e,t,a,r){var i=d[a],n=i.size,o=Math.ceil((t-e)/n),s=1,l=t-e;if(i.steps)for(var u=i.steps.length,c=0;c<u&&o>r;c++)s=i.steps[c],o=Math.ceil(l/(n*s));else for(;o>r&&r>0;)++s,o=Math.ceil(l/(n*s));return s}function c(e,a){var r,i,n=e.timeOpts.isoWeekday;return"week"===e.unit&&!1!==n?(r=t(a.min).startOf("isoWeek").isoWeekday(n).valueOf(),i=t(a.max).startOf("isoWeek").isoWeekday(n),a.max-i>0&&i.add(1,"week"),i=i.valueOf()):(r=t(a.min).startOf(e.unit).valueOf(),i=t(a.max).startOf(e.unit),a.max-i>0&&i.add(1,e.unit),i=i.valueOf()),o(e,a,{min:r,max:i})}function p(e,t,a){var r,i,n=e._start||{},o=e._view||{},s=e._model||{};for(r=0,i=t.length;r<i;++r){var l=t[r];n.hasOwnProperty(l)&&(n[l]-=a),o.hasOwnProperty(l)&&o!==n&&(o[l]-=a),s.hasOwnProperty(l)&&s!==o&&(s[l]-=a)}}var f=e.helpers,m={position:"bottom",time:{parser:!1,format:!1,unit:!1,round:!1,displayFormat:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{millisecond:"h:mm:ss.SSS a",second:"h:mm:ss a",minute:"h:mm a",hour:"hA",day:"MMM D",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"}},realtime:{duration:1e4,refresh:1e3,delay:0,onRefresh:null},ticks:{autoSkip:!1}};f.merge=function(e,t,r){var i,o,s,l,u,c=f.isArray(t)?t:[t],p=c.length;if(!a(e))return e;for(i=(r=r||{}).merger||n,o=0;o<p;++o)if(t=c[o],a(t))for(u=0,l=(s=Object.keys(t)).length;u<l;++u)i(s[u],e,t,r);return e},f.scaleMerge=function(){return f.merge(i(arguments[0]),[].slice.call(arguments,1),{merger:function(t,a,i,o){if("xAxes"===t||"yAxes"===t){var s,l,u,c=i[t].length;for(a[t]||(a[t]=[]),s=0;s<c;++s)l=r((u=i[t][s]).type,"xAxes"===t?"category":"linear"),s>=a[t].length&&a[t].push({}),!a[t][s].type||u.type&&u.type!==a[t][s].type?f.merge(a[t][s],[e.scaleService.getScaleDefaults(l),u]):f.merge(a[t][s],u)}else n(t,a,i,o)}})};var d={millisecond:{size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{size:1e3,steps:[1,2,5,10,30]},minute:{size:6e4,steps:[1,2,5,10,30]},hour:{size:36e5,steps:[1,2,3,6,12]},day:{size:864e5,steps:[1,2,5]},week:{size:6048e5,maxStep:4},month:{size:2628e6,maxStep:3},quarter:{size:7884e6,maxStep:4},year:{size:3154e7,maxStep:!1}},h={x:{data:["x","controlPointPreviousX","controlPointNextX"],dataset:["x"],tooltip:["x","caretX"]},y:{data:["y","controlPointPreviousY","controlPointNextY"],dataset:["y"],tooltip:["y","caretY"]}},v=e.scaleService.getScaleConstructor("time");e.scaleService.getScaleConstructor=function(e){return"time"===e&&(e="realtime"),this.constructors.hasOwnProperty(e)?this.constructors[e]:void 0};var g=v.extend({initialize:function(){v.prototype.initialize.call(this);var e=this,t=e.options;if("time"!==t.type||e.chart.options.plugins.streaming){var a=Date.now(),r=Date.now(),i=function(){var n,o,s=e.chart,l=t.realtime,u=l.duration,c=l.refresh;e.isHorizontal()?(o=e.width,n=h.x):(o=e.height,n=h.y);var m=Date.now(),d=o*(m-r)/u;f.each(s.data.datasets,function(e,t){var a,r,i=s.getDatasetMeta(t),o=i.data||[];for(a=0,r=o.length;a<r;++a)p(o[a],n.data,d);i.dataset&&p(i.dataset,n.dataset,d)}),p(s.tooltip,n.tooltip,d),m>=a?(a=m+c+(m-a)%c,l.onRefresh&&l.onRefresh.call(s,e),s.update()):(e.max=m-l.delay,e.min=e.max-u,s.animating||s.draw()),r=m,f.requestAnimFrame.call(window,i)};f.requestAnimFrame.call(window,i)}},buildTicks:function(){var e=this,t=e.options;if("time"!==t.type||e.chart.options.plugins.streaming){var a=t.time,i=t.realtime,n=Date.now()-i.delay,o=n-i.duration,p=e.getLabelCapacity(o),f=a.unit||s(a.minUnit,o,n,p),m=l(f);e.displayFormat=a.displayFormats[f],e.majorDisplayFormat=a.displayFormats[m],e.unit=f,e.majorUnit=m;var d=r(a.stepSize,a.unitStepSize)||u(o,n,f,p);e.ticks=c({maxTicks:p,min:o,max:n+i.refresh,stepSize:d,majorUnit:m,unit:f,timeOpts:a},{min:e.dataMin,max:e.dataMax}),e.max=n,e.min=o}else v.prototype.buildTicks.call(this)},draw:function(e){var t=this,a=t.chart;if("time"===t.options.type&&!a.options.plugins.streaming)return v.prototype.draw.call(this,e);var r=t.ctx,i=t.isHorizontal()?{left:e.left,top:0,right:e.right,bottom:a.height}:{left:0,top:e.top,right:a.width,bottom:e.bottom};f.canvas.clipArea(r,i),v.prototype.draw.call(this,e),f.canvas.unclipArea(r)},getPixelForOffset:function(e){var t=this;if("time"===t.options.type&&!t.chart.options.plugins.streaming)return v.prototype.getPixelForOffset.call(this,e);var a=t.max-t.min,r=a?(e-t.min)/a:0;return t.isHorizontal()?t.left+t.width*r:t.top+t.height*r}});e.scaleService.registerScaleType("realtime",g,m)}(e,t),e.plugins.getAll().forEach(function(t){if("filler"===t.id){var a=t.beforeDatasetDraw;t.beforeDatasetDraw=function(t,r){e.helpers.canvas.clipArea(t.ctx,t.chartArea),a(t,r),e.helpers.canvas.unclipArea(t.ctx)}}}),e.controllers.bar.prototype.calculateBarValuePixels=function(e,t){var a,r,i,n,o,s,l=this,u=l.chart,c=l.getMeta(),p=l.getValueScale(),f=u.data.datasets,m=p.getRightValue(f[e].data[t]),d=p.options.stacked,h=c.stack,v=0;if(d||void 0===d&&void 0!==h)for(a=0;a<e;++a)(r=u.getDatasetMeta(a)).bar&&r.stack===h&&r.controller.getValueScaleId()===p.id&&u.isDatasetVisible(a)&&(i=p.getRightValue(f[a].data[t]),(m<0&&i<0||m>=0&&i>0)&&(v+=i));return n=p.getPixelForValue(v),o=p.getPixelForValue(v+m),s=(o-n)/2,{size:s,base:n,head:o,center:o+s/2}},e.controllers.bar.prototype.draw=function(){var t=this,a=t.chart,r=t.getValueScale(),i=t.getMeta().data,n=t.getDataset(),o=i.length,s=0;for(e.helpers.canvas.clipArea(a.ctx,a.chartArea);s<o;++s)isNaN(r.getRightValue(n.data[s]))||i[s].draw();e.helpers.canvas.unclipArea(a.ctx)};var a=function(e){function t(e){var t,a,r,i,n=this,o=n.options.plugins.streaming,s=e.isHorizontal()?e.left:e.top;o.onRefresh&&o.onRefresh(n),n.data.datasets.forEach(function(n,o){for(t=n.data,a=2,r=t.length;a<r&&e.getPixelForValue(null,a,o)<=s;++a);t.splice(0,a-2),"object"!=typeof t[0]&&(i=a-2)}),i&&n.data.labels.splice(0,i)}return e.defaults.global.plugins.streaming={duration:1e4,refresh:1e3,delay:0,onRefresh:null},{id:"streaming",beforeUpdate:function(e,a){var r,i=e.options,n=i.scales;i.elements.line.capBezierPoints=!1,n.xAxes.concat(n.yAxes).forEach(function(e){"realtime"!==e.type&&"time"!==e.type||((r=e.realtime)||(r=e.realtime={}),r.duration=a.duration,r.refresh=a.refresh,r.delay=a.delay,r.onRefresh=t)})},beforeDraw:function(e){var t=e.lastMouseMoveEvent;return t&&e.canvas.dispatchEvent(t.native),!0},beforeEvent:function(e,t){return"mousemove"===t.type?e.lastMouseMoveEvent=t:"mouseout"===t.type&&delete e.lastMouseMoveEvent,!0}}}(e);return e.plugins.register(a),a});